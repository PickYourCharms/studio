<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bag - PickYourCharms</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=3.7">
</head>

<body>

<header class="navbar">
  <a href="index.html" class="logo-link">
    <img src="assets/home/PYC_LOGO_TEXT.png" class="logo-img" alt="PickYourCharms">
  </a>
  <button id="navCartBtn" class="cart-icon-btn" onclick="window.location.reload()">
    <div class="cart-badge-wrapper">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 5.68c.496 2.238.242 3.666-2.203 4.095-.97.17-2.025.218-3.116.218-1.09 0-2.146-.048-3.116-.218-2.445-.429-2.7-1.857-2.203-4.095l1.263-5.68c.24-1.08.385-1.92 2.053-2.008 2.025-.107 4.053-.107 6.078 0 1.668.088 1.813.928 2.053 2.008z" />
      </svg>
      <span id="cartCountBadge" class="cart-count">0</span>
    </div>
  </button>
</header>

<div class="page-header">
  <button onclick="window.location.href='index.html'">←</button>
  <h1>My Bag</h1>
  <div style="width: 24px;"></div>
</div>

<div class="main-container cart-page">
  
  <div id="emptyState" class="empty-state" style="display: none;">
    <img src="assets/home/curated_teaser.png" class="empty-img" style="filter:grayscale(1);">
    <h3>Nothing to see here yet!</h3>
    <p>Your bag is feeling lonely...</p>
    <button class="primary-btn" onclick="window.location.href='index.html'">Start Building</button>
  </div>

  <div id="cartContent" style="display: none;">
    
    <div id="cartItemsList" class="cart-list"></div>

    <div class="bill-summary">
      
      <div id="couponTrigger" class="coupon-trigger-btn" onclick="toggleCouponSheet()">
        <span>%</span> Apply Coupon
      </div>

      <div id="couponSheet" class="coupon-sheet">
        </div>

      <div id="appliedCouponView" class="coupon-applied-view">
        <span id="appliedCouponText"></span>
        <button class="remove-coupon-btn" onclick="removeCoupon()">✕</button>
      </div>

      <div class="math-row"> <span>Subtotal</span> <span id="subtotalVal">Rs. 0</span> </div>
      <div class="math-row discount-row" id="comboRow" style="display: none;"> <span>Combo Savings</span> <span id="comboVal">-Rs. 0</span> </div>
      <div class="math-row discount-row" id="couponRow" style="display: none;"> <span id="couponCodeLabel">Coupon</span> <span id="couponVal">-Rs. 0</span> </div>
      <div class="math-row"> <span>Shipping</span> <span id="shippingVal">Rs. 80</span> </div>
      <div class="divider"></div>
      <div class="math-row total-row"> <span>Total</span> <span id="finalTotal">Rs. 0</span> </div>
    </div>

    <div class="cart-footer-spacer"></div>
    <button id="checkoutBtn" class="checkout-pill" onclick="window.location.href='checkout.html'">Proceed to Checkout</button>
  </div>
</div>

<script>
// --- CONSTANTS ---
const BASE_PRICE = 249;
const EXTRA_CHARM_PRICE = 50;

// PREDEFINED COUPONS
const COUPONS_DB = [
  { code: "WELCOME10", percent: 10, minOrder: 0, desc: "10% off on your first order" },
  { code: "CHARM20", percent: 20, minOrder: 999, desc: "20% off on orders above Rs. 999" },
  { code: "FREESHIP", percent: 0, minOrder: 0, desc: "Free Shipping on all orders", freeShip: true }
];

const REF_SIZE = 300; 
const PHYSICS = { 
  bracelet: { anchorX:23, anchorY:6, attachOffset:2 },
  // FIXED EARRING PHYSICS FOR 70px THUMBNAIL
  // Hook Image has been moved up in CSS (top: 20px)
  // Charms need to hang from the loop of the hook.
  // Calculated for 300px scale:
  earrings: { leftX: 20, rightX: 236, y: 153 } 
};
const B_ANGLES = { 1:[90], 2:[70,110], 3:[60,90,120], 4:[45,75,105,135], 5:[40,65,90,115,140] };

let cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
let activeCoupon = null;

const listContainer = document.getElementById('cartItemsList');
const cartCountBadge = document.getElementById('cartCountBadge');
const emptyState = document.getElementById('emptyState');
const cartContent = document.getElementById('cartContent');
const couponSheet = document.getElementById('couponSheet');

function init() {
  cartCountBadge.textContent = cart.length;
  document.getElementById('navCartBtn').style.display = cart.length > 0 ? 'block' : 'none';

  if (cart.length === 0) {
    emptyState.style.display = 'flex';
    cartContent.style.display = 'none';
  } else {
    emptyState.style.display = 'none';
    cartContent.style.display = 'block';
    renderItems();
    renderCoupons();
    calculateTotals();
  }
}

// --- MINI BUILDERS ---
function buildMiniBracelet(metal, charms) {
  const container = document.createElement('div');
  container.className = 'mini-canvas-scaler';
  
  const base = document.createElement('img');
  base.className = 'mini-base';
  base.src = `assets/bases/bracelet_base_${metal}.png`;
  container.appendChild(base);

  const cx = REF_SIZE / 2, cy = REF_SIZE / 2, radius = REF_SIZE * 0.36;
  const angles = B_ANGLES[charms.length] || [];

  charms.forEach((file, i) => {
    const a = angles[angles.length - 1 - i];
    const rad = a * Math.PI / 180;
    const x = cx + radius * Math.cos(rad);
    const y = cy + radius * Math.sin(rad) + PHYSICS.bracelet.attachOffset;
    
    const img = document.createElement('img');
    img.className = 'mini-charm';
    img.src = `assets/charms/${file}`;
    img.style.left = (x - PHYSICS.bracelet.anchorX) + 'px';
    img.style.top = (y - PHYSICS.bracelet.anchorY) + 'px';
    img.style.transform = `rotate(${a - 90}deg)`;
    container.appendChild(img);
  });
  return container;
}

function buildMiniEarrings(metal, charms) {
  const container = document.createElement('div');
  container.className = 'mini-canvas-scaler';

  const lHook = document.createElement('img');
  lHook.src = `assets/bases/LeftHook_${metal}.png`;
  lHook.className = 'mini-hook left';
  container.appendChild(lHook);

  const rHook = document.createElement('img');
  rHook.src = `assets/bases/RightHook_${metal}.png`;
  rHook.className = 'mini-hook right';
  container.appendChild(rHook);

  if (charms.left) {
    const c = document.createElement('img');
    c.className = 'mini-charm';
    c.src = `assets/charms/${charms.left}`;
    c.style.left = (PHYSICS.earrings.leftX - 23) + 'px';
    c.style.top = PHYSICS.earrings.y + 'px';
    container.appendChild(c);
  }
  if (charms.right) {
    const c = document.createElement('img');
    c.className = 'mini-charm';
    c.src = `assets/charms/${charms.right}`;
    c.style.left = (PHYSICS.earrings.rightX - 23) + 'px';
    c.style.top = PHYSICS.earrings.y + 'px';
    container.appendChild(c);
  }
  return container;
}

// --- HELPER: Title Generator ---
function getComboTitle(bMetal, eMetal) {
  if (bMetal === eMetal) {
    return `${bMetal.charAt(0).toUpperCase() + bMetal.slice(1)} Combo Set`;
  } else {
    return `Mixed Metal Combo`;
  }
}

// --- RENDERER ---
function renderItems() {
  listContainer.innerHTML = '';

  cart.forEach((item, index) => {
    
    if (item.type.includes('Combo')) {
      // === COMBO CARD ===
      const comboCard = document.createElement('div');
      comboCard.className = 'combo-card-group';

      // 1. Header
      const header = document.createElement('div');
      header.className = 'combo-group-header';
      // Use helper for title
      const title = getComboTitle(item.bracelet.metal, item.earrings.metal);
      
      header.innerHTML = `
        <div class="combo-header-info">
          <span class="combo-header-title">${title}</span>
          <span class="combo-header-price">Rs. ${item.price}</span>
        </div>
      `;
      comboCard.appendChild(header);

      // 2. Bracelet Row
      const bRow = document.createElement('div');
      bRow.className = 'combo-sub-item';
      const bWrapper = document.createElement('div');
      bWrapper.className = 'item-row-content';

      const bThumb = document.createElement('div');
      bThumb.className = 'item-thumb';
      bThumb.appendChild(buildMiniBracelet(item.bracelet.metal, item.bracelet.charms));
      const bBadge = document.createElement('div');
      bBadge.className = 'charm-badge';
      bBadge.textContent = item.bracelet.charms.length;
      bThumb.appendChild(bBadge);

      const bDetails = document.createElement('div');
      bDetails.className = 'item-details';
      bDetails.innerHTML = `
        <div class="sub-item-name">Bracelet</div>
        <div class="sub-item-meta">${item.bracelet.metal} base</div>
      `;

      const bActions = document.createElement('div');
      bActions.className = 'item-actions';
      bActions.innerHTML = `
        <button class="icon-btn edit-btn" onclick="editItem(${index}, 'bracelet')">✎</button>
        <button class="icon-btn delete-btn" onclick="deleteItem(${index}, 'bracelet')">✕</button>
      `;

      bWrapper.appendChild(bThumb);
      bWrapper.appendChild(bDetails);
      bWrapper.appendChild(bActions);
      bRow.appendChild(bWrapper);
      comboCard.appendChild(bRow);

      // 3. Earring Row
      const eRow = document.createElement('div');
      eRow.className = 'combo-sub-item';
      const eWrapper = document.createElement('div');
      eWrapper.className = 'item-row-content';

      const eThumb = document.createElement('div');
      eThumb.className = 'item-thumb';
      eThumb.appendChild(buildMiniEarrings(item.earrings.metal, item.earrings.charms));
      const eCount = (item.earrings.charms.left?1:0) + (item.earrings.charms.right?1:0);
      const eBadge = document.createElement('div');
      eBadge.className = 'charm-badge';
      eBadge.textContent = eCount;
      eThumb.appendChild(eBadge);

      const eDetails = document.createElement('div');
      eDetails.className = 'item-details';
      eDetails.innerHTML = `
        <div class="sub-item-name">Earrings</div>
        <div class="sub-item-meta">${item.earrings.metal} base</div>
      `;

      const eActions = document.createElement('div');
      eActions.className = 'item-actions';
      eActions.innerHTML = `
        <button class="icon-btn edit-btn" onclick="editItem(${index}, 'earrings')">✎</button>
        <button class="icon-btn delete-btn" onclick="deleteItem(${index}, 'earrings')">✕</button>
      `;

      eWrapper.appendChild(eThumb);
      eWrapper.appendChild(eDetails);
      eWrapper.appendChild(eActions);
      eRow.appendChild(eWrapper);
      comboCard.appendChild(eRow);

      listContainer.appendChild(comboCard);

    } else {
      // === SINGLE CARD ===
      const card = document.createElement('div');
      card.className = 'cart-item-card';
      const wrapper = document.createElement('div');
      wrapper.className = 'item-row-content';
      
      const thumbBox = document.createElement('div');
      thumbBox.className = 'item-thumb';
      
      let charmCount = 0;
      let displayTitle = '';
      
      if (item.type === 'Bracelet') {
        thumbBox.appendChild(buildMiniBracelet(item.metal, item.charms));
        charmCount = item.charms.length;
        displayTitle = `${item.metal} Bracelet`;
      } else {
        thumbBox.appendChild(buildMiniEarrings(item.metal, item.charms));
        charmCount = (item.charms.left?1:0) + (item.charms.right?1:0);
        displayTitle = `${item.metal} Earrings`;
      }

      const badge = document.createElement('div');
      badge.className = 'charm-badge';
      badge.textContent = charmCount;
      thumbBox.appendChild(badge);

      const details = document.createElement('div');
      details.className = 'item-details';
      details.innerHTML = `
        <div class="item-title">${displayTitle}</div>
        <div class="item-price">Rs. ${item.price}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'item-actions';
      actions.innerHTML = `
        <button class="icon-btn edit-btn" onclick="editItem(${index})">✎</button>
        <button class="icon-btn delete-btn" onclick="deleteItem(${index})">✕</button>
      `;

      wrapper.appendChild(thumbBox);
      wrapper.appendChild(details);
      wrapper.appendChild(actions);
      card.appendChild(wrapper);
      listContainer.appendChild(card);
    }
  });
}

// --- COUPON SYSTEM ---
function renderCoupons() {
  couponSheet.innerHTML = '';
  COUPONS_DB.forEach(coupon => {
    const card = document.createElement('div');
    card.className = 'coupon-card';
    card.onclick = () => selectCoupon(coupon);
    card.innerHTML = `
      <div class="coupon-info">
        <h4>${coupon.code}</h4>
        <p>${coupon.desc}</p>
      </div>
      <div class="coupon-apply-text">APPLY</div>
    `;
    couponSheet.appendChild(card);
  });
}

function toggleCouponSheet() {
  couponSheet.classList.toggle('active');
  const trigger = document.getElementById('couponTrigger');
  trigger.style.display = couponSheet.classList.contains('active') ? 'none' : 'flex';
}

function selectCoupon(coupon) {
  activeCoupon = coupon;
  toggleCouponSheet();
  
  // Show Applied View
  document.getElementById('couponTrigger').style.display = 'none';
  document.getElementById('appliedCouponView').style.display = 'flex';
  document.getElementById('appliedCouponText').textContent = `Applied: ${coupon.code}`;
  
  calculateTotals();
}

function removeCoupon() {
  activeCoupon = null;
  document.getElementById('appliedCouponView').style.display = 'none';
  document.getElementById('couponTrigger').style.display = 'flex';
  calculateTotals();
}

// --- MATH & ACTIONS ---
function calculateTotals() {
  let bracelets = [];
  let earrings = [];
  const getBPrice = (b) => BASE_PRICE + (b.charms.length-1)*EXTRA_CHARM_PRICE;
  const getEPrice = () => BASE_PRICE;

  cart.forEach(item => {
    if(item.type === 'Bracelet') bracelets.push(getBPrice(item));
    else if(item.type === 'Earrings') earrings.push(getEPrice());
    else if(item.type.includes('Combo')) {
      bracelets.push(getBPrice(item.bracelet));
      earrings.push(getEPrice());
    }
  });

  let subtotal = 0;
  bracelets.forEach(p => subtotal += p);
  earrings.forEach(p => subtotal += p);

  bracelets.sort((a,b) => a-b);
  let comboDiscount = 0;
  const pairs = Math.min(bracelets.length, earrings.length);
  for(let i=0; i<pairs; i++) {
    comboDiscount += Math.floor((bracelets[i] + earrings[i]) * 0.10);
  }

  let discountable = subtotal - comboDiscount;
  let couponDisc = 0;
  let forceFreeShip = false;

  if (activeCoupon) {
    if (activeCoupon.freeShip) {
      forceFreeShip = true;
    } else if (discountable >= activeCoupon.minOrder) {
      couponDisc = Math.floor(discountable * (activeCoupon.percent / 100));
    } else {
      // Coupon invalid for amount
      // Ideally show toast, but for now just don't apply discount
    }
  }

  let shipping = 80;
  if (forceFreeShip || (discountable - couponDisc >= 399)) {
    shipping = 0;
  }

  let total = subtotal - comboDiscount - couponDisc + shipping;

  document.getElementById('subtotalVal').textContent = `Rs. ${subtotal}`;
  
  const comboRow = document.getElementById('comboRow');
  comboRow.style.display = comboDiscount > 0 ? 'flex' : 'none';
  document.getElementById('comboVal').textContent = `-Rs. ${comboDiscount}`;

  const couponRow = document.getElementById('couponRow');
  couponRow.style.display = (couponDisc > 0 || forceFreeShip) ? 'flex' : 'none';
  if(activeCoupon) {
    document.getElementById('couponCodeLabel').textContent = `Coupon (${activeCoupon.code})`;
    document.getElementById('couponVal').textContent = couponDisc > 0 ? `-Rs. ${couponDisc}` : 'Applied';
  }

  const shipEl = document.getElementById('shippingVal');
  shipEl.textContent = shipping === 0 ? 'FREE' : `Rs. ${shipping}`;
  shipEl.style.color = shipping === 0 ? '#15803d' : '#111';

  document.getElementById('finalTotal').textContent = `Rs. ${total}`;
}

function deleteItem(index, subType = null) {
  if (subType === null) {
    cart.splice(index, 1);
  } else {
    const combo = cart[index];
    if (subType === 'bracelet') {
      const newEarring = {
        id: Date.now(),
        type: 'Earrings',
        metal: combo.earrings.metal,
        charms: combo.earrings.charms,
        price: BASE_PRICE,
        image: `assets/bases/LeftHook_${combo.earrings.metal}.png`
      };
      cart[index] = newEarring;
    } 
    else if (subType === 'earrings') {
      const bPrice = BASE_PRICE + (combo.bracelet.charms.length - 1) * EXTRA_CHARM_PRICE;
      const newBracelet = {
        id: Date.now(),
        type: 'Bracelet',
        metal: combo.bracelet.metal,
        charms: combo.bracelet.charms,
        price: bPrice,
        image: `assets/bases/bracelet_base_${combo.bracelet.metal}.png`
      };
      cart[index] = newBracelet;
    }
  }
  localStorage.setItem('pyc_cart', JSON.stringify(cart));
  init();
}

function editItem(index, subType) {
  const item = cart[index];
  let draft = {};
  let url = '';

  sessionStorage.removeItem('pyc_draft');
  sessionStorage.removeItem('combo_bracelet_data');
  sessionStorage.removeItem('combo_earring_data');

  if (item.type.includes('Combo')) {
    if (subType === 'bracelet') {
      draft = { url: 'builder.html?mode=combo', data: { metal: item.bracelet.metal, charms: item.bracelet.charms } };
      url = 'builder.html?mode=combo&resume=true';
    } else {
      sessionStorage.setItem('combo_bracelet_data', JSON.stringify(item.bracelet));
      draft = { 
        url: 'earring-builder.html?mode=combo', 
        data: { metal: item.earrings.metal, charms: item.earrings.charms },
        comboContext: { bracelet: item.bracelet }
      };
      url = 'earring-builder.html?mode=combo&resume=true';
    }
  } 
  else if (item.type === 'Bracelet') {
    draft = { url: 'builder.html', data: { metal: item.metal, charms: item.charms } };
    url = 'builder.html?resume=true';
  } 
  else { 
    draft = { url: 'earring-builder.html', data: { metal: item.metal, charms: item.charms } };
    url = 'earring-builder.html?resume=true';
  }

  sessionStorage.setItem('pyc_draft', JSON.stringify(draft));
  cart.splice(index, 1);
  localStorage.setItem('pyc_cart', JSON.stringify(cart));
  window.location.href = url;
}

init();
</script>
</body>
</html>
