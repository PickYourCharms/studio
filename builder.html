<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Build My Bracelet</title>
<link rel="stylesheet" href="styles.css?v=2.0">
<style>
/* Local overrides if needed (Moved most to styles.css for cleanliness) */
body { background: #f6f3ec; padding: 14px 14px 100px 14px; } /* Padding for bottom spacing */

.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.header button { background: none; border: none; font-size: 14px; cursor: pointer; }

/* Builder Components */
.metal-toggle { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
.metal-toggle button { padding: 8px 18px; border-radius: 999px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
.metal-toggle button.active { background: #000; color: #fff; border-color: #000; }

.builder-surface { background: #ffffff; border-radius: 26px; padding: 10px 12px 18px; margin: 0 auto; max-width: 420px; box-shadow: 0 18px 40px rgba(0,0,0,0.06); }
.canvas { position: relative; width: 100%; max-width: 360px; aspect-ratio: 1 / 1; margin: -6px auto 0; }
.bracelet { position: absolute; width: 72%; height: 72%; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }

.price-pill { position: absolute; top: 6%; right: 6%; padding: 6px 14px; border-radius: 999px; background: rgba(255,255,255,0.95); font-size: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.15); opacity: 0; transform: translateY(6px); transition: all 0.2s ease; }
.price-pill.show { opacity: 1; transform: translateY(0); }

.charm { position: absolute; cursor: pointer; transform-origin: top center; }
.charm img { width: 46px; }

.reset-row { text-align: right; margin: 6px auto 10px; max-width: 360px; }
.reset-row button { background: none; border: none; font-size: 14px; color: #777; cursor: pointer; }

.helper { font-size: 13px; color: #777; margin-top: 10px; }

.tray-surface { background: #ffffff; border-radius: 22px; padding: 14px 10px; margin: 14px auto 0; max-width: 420px; box-shadow: 0 12px 28px rgba(0,0,0,0.05); }
.tray { display: flex; justify-content: center; gap: 18px; }
.tray img { width: 44px; cursor: pointer; }

.cta { position: fixed; bottom: 20px; left: 14px; right: 14px; padding: 16px; border-radius: 999px; background: #000; color: #fff; border: none; font-size: 16px; cursor: pointer; opacity: 0; transform: translateY(12px); transition: all 0.25s ease; }
.cta.show { opacity: 1; transform: translateY(0); }

/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 999; }
.modal-card { background: #fff; border-radius: 18px; padding: 20px; width: 86%; max-width: 320px; text-align: center; }
.modal-actions { display: flex; gap: 10px; margin-top: 16px; }
.modal-actions button { flex: 1; padding: 12px; border-radius: 999px; border: none; cursor: pointer; }
.primary { background: #000; color: #fff; }
.secondary { background: #eee; }
</style>
</head>

<body>

<div class="header">
  <button onclick="goBack()">← Back</button>
  <button id="navCartBtn" class="cart-icon-btn" onclick="window.location.href='cart.html'">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 5.68c.496 2.238.242 3.666-2.203 4.095-.97.17-2.025.218-3.116.218-1.09 0-2.146-.048-3.116-.218-2.445-.429-2.7-1.857-2.203-4.095l1.263-5.68c.24-1.08.385-1.92 2.053-2.008 2.025-.107 4.053-.107 6.078 0 1.668.088 1.813.928 2.053 2.008z" />
    </svg>
  </button>
</div>

<h2>Build My Bracelet</h2>

<div class="metal-toggle">
  <button id="goldBtn" class="active" onclick="onMetalClick('gold')">Gold</button>
  <button id="silverBtn" onclick="onMetalClick('silver')">Silver</button>
</div>

<div class="builder-surface">
  <div class="canvas" id="canvas">
    <img id="bracelet" class="bracelet" src="assets/bases/bracelet_base_gold.png">
    <div id="pricePill" class="price-pill"></div>
  </div>

  <div class="reset-row">
    <button onclick="onResetClick()">Reset</button>
  </div>

  <div class="helper">Tap a charm to add • Tap charm to remove</div>
</div>

<div class="tray-surface">
  <div class="tray" id="tray"></div>
</div>

<button id="cta" class="cta">Love it · Add to Bag</button>

<div class="post-actions-container">
  <button class="action-btn btn-build-more" onclick="window.location.href='index.html'">Build More</button>
  <button class="action-btn btn-view-cart" onclick="window.location.href='cart.html'">View Cart</button>
</div>

<div id="modal" class="modal">
  <div class="modal-card">
    <div id="modalText"></div>
    <div class="modal-actions">
      <button class="secondary" onclick="closeModal()">Cancel</button>
      <button class="primary" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<script>
const BASE_PRICE = 249;
const EXTRA_CHARM_PRICE = 50;
const PHYSICS = { size:46, anchorX:23, anchorY:6, attachOffset:2 };
const SLOT_ANGLES = { 1:[90], 2:[70,110], 3:[60,90,120], 4:[45,75,105,135], 5:[40,65,90,115,140] };
const CHARMS = {
  gold: [ '3DBowRibbon_Charm_Gold.png', 'EvilEye_Charm_Gold.png', 'LetterA_Charm_Gold.png', 'NorthStar_Charm_Gold.png', 'RedCherry_Charm_Gold.png' ],
  silver: [ '3DBowRibbon_Charm_Silver.png', 'EvilEye_Charm_Silver.png', 'LetterA_Charm_Silver.png', 'NorthStar_Charm_Silver.png', 'RedCherry_Charm_Silver.png' ]
};

let metal = 'gold';
let charms = [];

// DOM
const canvas = document.getElementById('canvas');
const bracelet = document.getElementById('bracelet');
const tray = document.getElementById('tray');
const pricePill = document.getElementById('pricePill');
const cta = document.getElementById('cta');
const modal = document.getElementById('modal');
const modalText = document.getElementById('modalText');
const modalConfirm = document.getElementById('modalConfirm');
const navCartBtn = document.getElementById('navCartBtn');

// QUERY PARAMS
const urlParams = new URLSearchParams(window.location.search);
const isCombo = urlParams.get('mode') === 'combo';
const isResume = urlParams.get('resume') === 'true';

// INIT
function init() {
  // Check Cart Icon
  const cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
  if (cart.length > 0) navCartBtn.style.display = 'block';

  if (isResume) {
    const draft = JSON.parse(sessionStorage.getItem('pyc_draft'));
    if (draft && draft.data) {
      metal = draft.data.metal;
      charms = draft.data.charms;
    }
  } 
  else if (isCombo) {
    const savedData = sessionStorage.getItem('combo_bracelet_data');
    if (savedData) {
      const data = JSON.parse(savedData);
      metal = data.metal;
      charms = data.charms;
    }
    cta.textContent = "Continue to Earrings →";
  }

  updateMetal(); 
}

function saveDraft() {
  const draftData = {
    url: 'builder.html' + window.location.search,
    data: { metal, charms },
    timestamp: Date.now()
  };
  sessionStorage.setItem('pyc_draft', JSON.stringify(draftData));
}

function goBack() {
  if (isCombo) {
    window.location.href = 'index.html'; 
  } else {
    history.back();
  }
}

function loadTray(){
  tray.innerHTML='';
  CHARMS[metal].forEach(file=>{
    const img=document.createElement('img');
    img.src='assets/charms/'+file;
    img.onclick=()=>addCharm(file);
    tray.appendChild(img);
  });
}

function addCharm(file){
  if(charms.length>=5) return;
  charms.push(file);
  render();
  saveDraft(); 
}

function render(){
  document.querySelectorAll('.charm').forEach(el=>el.remove());

  if(charms.length===0){
    pricePill.classList.remove('show');
    cta.classList.remove('show');
    return;
  }

  const totalPrice = BASE_PRICE + (charms.length-1)*EXTRA_CHARM_PRICE;
  pricePill.textContent='Rs. '+ totalPrice;
  pricePill.classList.add('show');
  cta.classList.add('show');

  const rect=canvas.getBoundingClientRect();
  const cx=rect.width/2, cy=rect.height/2;
  const radius=rect.width*0.36;
  const angles=SLOT_ANGLES[charms.length];

  charms.forEach((file,i)=>{
    const a=angles[angles.length-1-i];
    const rad=a*Math.PI/180;
    const x=cx+radius*Math.cos(rad);
    const y=cy+radius*Math.sin(rad)+PHYSICS.attachOffset;

    const w=document.createElement('div');
    w.className='charm';
    w.style.left=(x-PHYSICS.anchorX)+'px';
    w.style.top=(y-PHYSICS.anchorY)+'px';
    w.style.transform='rotate('+(a-90)+'deg)';
    
    const img=document.createElement('img');
    img.src='assets/charms/'+file;
    w.appendChild(img);
    w.onclick=()=>{
      // Prevent removal if frozen
      if(document.body.classList.contains('frozen-state')) return;
      charms.splice(i,1);render();saveDraft();
    }; 
    canvas.appendChild(w);
  });
}

function onMetalClick(next){
  if(next===metal) return;
  if(charms.length>0){
    showModal('Switching metal will reset your design.',()=>{
      charms=[];
      metal=next;
      updateMetal();
      saveDraft(); 
    });
  } else {
    metal=next;
    updateMetal();
    saveDraft(); 
  }
}

function onResetClick(){
  if(charms.length===0) return;
  showModal('Reset bracelet design?',()=>{
    charms=[];
    render();
    saveDraft(); 
  });
}

function updateMetal(){
  bracelet.src='assets/bases/bracelet_base_'+metal+'.png';
  document.getElementById('goldBtn').classList.toggle('active',metal==='gold');
  document.getElementById('silverBtn').classList.toggle('active',metal==='silver');
  loadTray();
  render();
}

// CTA HANDLER
cta.onclick = function() {
  if (isCombo) {
    const state = { metal, charms };
    sessionStorage.setItem('combo_bracelet_data', JSON.stringify(state));
    
    const draftData = {
      url: 'earring-builder.html?mode=combo',
      data: { metal: 'gold', charms: {left:null,right:null} }, 
      comboContext: { bracelet: state }
    };
    sessionStorage.setItem('pyc_draft', JSON.stringify(draftData));

    window.location.href = 'earring-builder.html?mode=combo';
  } else {
    // SINGLE FLOW FINAL SUBMIT
    const product = {
      id: Date.now(),
      type: 'Bracelet',
      metal: metal,
      charms: charms,
      price: BASE_PRICE + (charms.length-1)*EXTRA_CHARM_PRICE,
      image: 'assets/bases/bracelet_base_'+metal+'.png'
    };

    addToCart(product);
  }
};

function addToCart(item) {
  let cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
  cart.push(item);
  localStorage.setItem('pyc_cart', JSON.stringify(cart));

  // Clear Draft
  sessionStorage.removeItem('pyc_draft');

  // FREEZE UI
  document.body.classList.add('frozen-state');

  // SHOW CART ICON IMMEDIATELY
  navCartBtn.style.display = 'block';
}

function showModal(text,confirmFn){
  modalText.textContent=text;
  modalConfirm.onclick=()=>{ closeModal(); confirmFn(); };
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; }

init();
</script>
</body>
</html>
