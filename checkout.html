<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Checkout - PickYourCharms</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=6.0">

  <style>
    /* === CHECKOUT SPECIFIC STYLES === */
    body { background-color: #ffffff; }
    
    .checkout-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 120px 16px;
    }

    .section-title {
      font-size: 15px; font-weight: 700; color: #111;
      margin-bottom: 12px; margin-top: 30px;
    }
    .section-desc { font-size: 13px; color: #888; margin-top: -8px; margin-bottom: 16px; }

    /* INPUTS */
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block; font-size: 13px; font-weight: 600; color: #444;
      margin-bottom: 6px; margin-left: 4px;
    }
    .required-star { color: #dc2626; margin-left: 2px; }
    .optional-tag { color: #999; font-weight: 400; font-size: 12px; margin-left: 4px; }

    .premium-input {
      width: 100%; padding: 14px 16px;
      background: #fafafa; border: 1px solid #e5e5e5;
      border-radius: 12px; font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 16px; color: #111; outline: none;
      transition: all 0.2s ease; appearance: none;
    }
    .premium-input:focus { background: #fff; border-color: #000; }
    
    /* READONLY INPUTS (Frozen State) */
    .premium-input[readonly] {
      background-color: #f3f4f6; /* Greyed out */
      color: #888;
      border-color: #e5e5e5;
      pointer-events: none;
    }

    /* PHONE INPUT SPECIFIC */
    .phone-wrapper { position: relative; }
    .phone-prefix {
      position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      font-size: 16px; color: #111; font-weight: 500; pointer-events: none;
      display: flex; align-items: center; gap: 6px;
    }
    input.phone-field { padding-left: 85px; }

    /* ERROR STATE */
    .premium-input.input-error {
      border-color: #dc2626 !important;
      background-color: #fef2f2 !important;
      animation: shake 0.3s ease;
    }
    .premium-input.input-error::placeholder { color: #f87171; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    
    .form-row { display: flex; gap: 12px; }
    .form-col { flex: 1; }

    /* VIBE SCROLLER */
    .vibe-scroll-container {
      display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px;
      margin: 0 -16px 20px -16px; padding-left: 16px; padding-right: 16px;
      scrollbar-width: none;
    }
    .vibe-scroll-container::-webkit-scrollbar { display: none; }
    
    .vibe-chip {
      padding: 10px 20px; background: #fff; border: 1px solid #eee;
      border-radius: 999px; font-size: 14px; font-weight: 600; color: #555;
      white-space: nowrap; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }
    .vibe-chip.selected {
      background: #000; color: #fff; border-color: #000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* TOGGLE */
    .toggle-container {
      display: flex; justify-content: space-between; align-items: center;
      background: #f9f9f9; padding: 16px; border-radius: 16px; margin-bottom: 24px;
    }
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 24px; width: 24px;
      left: 2px; bottom: 2px; background-color: white; transition: .4s;
      border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .slider { background-color: #000; }
    input:checked + .slider:before { transform: translateX(22px); }

    .hidden-section { display: none; animation: slideDown 0.3s ease forwards; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* CLEAN RECEIPT CARD */
    .receipt-card {
      background: #fff; border: 1px solid #f0f0f0; border-radius: 20px;
      padding: 24px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); margin-top: 30px;
    }
    .bill-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #555; }
    .bill-row.total {
      margin-top: 16px; padding-top: 16px; border-top: 1px dashed #ddd;
      font-size: 18px; font-weight: 800; color: #000;
    }
    .discount-text { color: #15803d; }

    /* FOOTER */
    .sticky-footer {
      position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
      padding: 16px; border-top: 1px solid #f0f0f0; display: flex; justify-content: center;
      z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .whatsapp-btn {
      width: 100%; max-width: 500px; background: #25D366; color: #fff;
      border: none; padding: 16px; border-radius: 999px; font-size: 16px; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
    }
    .helper-text { font-size: 12px; color: #666; margin-top: 4px; }
    
    /* MODAL FOR BACK BUTTON */
    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .modal-card {
      background: #fff; border-radius: 18px; padding: 20px; width: 86%; max-width: 320px; text-align: center;
    }
    .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
    .modal-actions button { flex: 1; padding: 12px; border-radius: 999px; border: none; cursor: pointer; }
    .primary { background: #000; color: #fff; }
    .secondary { background: #eee; }
  </style>
</head>

<body>

<div class="header">
  <button onclick="handleBackNavigation()">‚Üê</button>
  <a href="index.html" class="logo-link">
    <img src="assets/home/PYC_LOGO_TEXT.png" class="logo-img" alt="PickYourCharms">
  </a>
  <div style="width: 24px;"></div> 
</div>

<div class="checkout-container">
  
  <div style="margin-top: 20px;">
    <h1 style="font-size: 24px; font-weight: 800; margin-bottom: 24px;">Checkout</h1>
  </div>

  <h3 class="section-title">What's the vibe? ‚òÅÔ∏è</h3>
  <p class="section-desc">Helps us pack it right (Optional)</p>
  
  <div class="vibe-scroll-container">
    <button class="vibe-chip" onclick="selectVibe(this, 'Calm')">Calm üåø</button>
    <button class="vibe-chip" onclick="selectVibe(this, 'Romantic')">Romantic üåπ</button>
    <button class="vibe-chip" onclick="selectVibe(this, 'Dark')">Dark üñ§</button>
    <button class="vibe-chip" onclick="selectVibe(this, 'Playful')">Playful üç≠</button>
    <button class="vibe-chip" onclick="selectVibe(this, 'Minimal')">Minimal ‚ú®</button>
    <button class="vibe-chip" onclick="selectVibe(this, 'Other')">Other ‚úèÔ∏è</button>
  </div>
  <div id="otherVibeInput" class="form-group" style="display:none;">
    <input type="text" id="vibeText" class="premium-input" placeholder="Type your vibe here..." oninput="saveDraft()">
  </div>

  <h3 class="section-title" style="margin-top: 30px;">Contact Info</h3>
  
  <div class="form-group">
    <label class="form-label">Full Name <span class="required-star">*</span></label>
    <input type="text" id="customerName" class="premium-input" placeholder="e.g. Ananya Singh" 
           autocomplete="name" 
           oninput="validateInput(this); saveDraft()">
  </div>

  <div class="form-group">
    <label class="form-label">Phone Number <span class="required-star">*</span></label>
    <div class="phone-wrapper">
      <span class="phone-prefix">üáÆüá≥ +91</span>
      <input type="tel" id="customerPhone" class="premium-input phone-field" placeholder="98765 43210" 
             autocomplete="tel"
             oninput="handlePhoneInput(event, this)" 
             onblur="saveDraft()">
    </div>
  </div>

  <div class="form-group">
    <label class="form-label">Email Address <span class="required-star">*</span></label>
    <input type="email" id="customerEmail" class="premium-input" placeholder="name@example.com" 
           autocomplete="email"
           oninput="validateInput(this); saveDraft()">
  </div>

  <div class="toggle-container" style="margin-top: 30px;">
    <div>
      <div style="font-weight: 700; font-size: 15px;">Is this a gift? üéÅ</div>
      <div style="font-size: 12px; color: #888;">We'll pack it extra special</div>
    </div>
    <label class="switch">
      <input type="checkbox" id="isGift" onchange="toggleGiftSection()">
      <span class="slider"></span>
    </label>
  </div>

  <div id="giftSection" class="hidden-section">
    <div class="form-group" style="display:flex; align-items:center; gap:8px; margin-bottom:20px;">
      <input type="checkbox" id="copyDetails" onchange="copyContactDetails()" style="width:18px; height:18px;">
      <label for="copyDetails" style="font-size:14px; font-weight:600;">Same as contact info</label>
    </div>

    <div class="form-group">
      <label class="form-label">Receiver Name <span class="required-star">*</span></label>
      <input type="text" id="receiverName" class="premium-input" oninput="validateInput(this); saveDraft()">
    </div>

    <div class="form-group">
      <label class="form-label">Receiver Phone <span class="required-star">*</span></label>
      <div class="phone-wrapper">
        <span class="phone-prefix">üáÆüá≥ +91</span>
        <input type="tel" id="receiverPhone" class="premium-input phone-field" 
               oninput="handlePhoneInput(event, this)" 
               onblur="saveDraft()">
      </div>
    </div>

    <div class="form-row" style="margin-top: 16px;">
      <div class="form-col">
        <label class="form-label">Relation <span class="optional-tag">(Optional)</span></label>
        <input type="text" id="relation" class="premium-input" placeholder="Sister..." oninput="saveDraft()">
      </div>
      <div class="form-col">
        <label class="form-label">Occasion <span class="optional-tag">(Optional)</span></label>
        <input type="text" id="occasion" class="premium-input" placeholder="Birthday..." oninput="saveDraft()">
      </div>
    </div>

    <div class="form-group" style="margin-top: 16px;">
      <label class="form-label">Message on Card <span class="optional-tag">(Optional)</span></label>
      <input type="text" id="giftMessage" class="premium-input" placeholder="Write a short note..." oninput="saveDraft()">
    </div>
  </div>

  <h3 class="section-title" style="margin-top: 30px;">Shipping Address</h3>
  
  <div class="form-group">
    <label class="form-label">Flat / House No / Building <span class="required-star">*</span></label>
    <input type="text" id="addressLine1" class="premium-input" placeholder="e.g. 104, Sunrise Apartments" 
           autocomplete="address-line1"
           oninput="validateInput(this); saveDraft()">
  </div>

  <div class="form-group">
    <label class="form-label">Road Name / Area / Colony <span class="required-star">*</span></label>
    <input type="text" id="addressLine2" class="premium-input" placeholder="e.g. MG Road, Indiranagar" 
           autocomplete="address-line2"
           oninput="validateInput(this); saveDraft()">
  </div>

  <div class="form-group">
    <label class="form-label">Landmark <span class="optional-tag">(Optional)</span></label>
    <input type="text" id="landmark" class="premium-input" placeholder="e.g. Near Metro Station" oninput="saveDraft()">
  </div>

  <div class="form-group">
    <label class="form-label">Pincode <span class="required-star">*</span></label>
    <input type="tel" id="pincode" class="premium-input" placeholder="560001" maxlength="6" 
           autocomplete="postal-code"
           oninput="handlePincodeInput(this)">
    <div id="pincodeMsg" class="helper-text"></div>
  </div>

  <div class="form-row">
    <div class="form-col">
      <label class="form-label">City</label>
      <input type="text" id="city" class="premium-input" placeholder="City" readonly autocomplete="address-level2">
    </div>
    <div class="form-col">
      <label class="form-label">State</label>
      <input type="text" id="state" class="premium-input" placeholder="State" readonly autocomplete="address-level1">
    </div>
  </div>

  <div class="receipt-card">
    <h3 class="section-title" style="margin-top:0; margin-bottom: 20px;">Payment Summary</h3>
    
    <div>
      <div class="bill-row"><span>Subtotal</span><span id="subtotalVal">Rs. 0</span></div>
      <div class="bill-row discount-text" id="comboRow" style="display:none;"><span>Combo Savings</span><span id="comboVal">-Rs. 0</span></div>
      <div class="bill-row discount-text" id="couponRow" style="display:none;"><span>Coupon</span><span id="couponVal">-Rs. 0</span></div>
      <div class="bill-row"><span>Shipping</span><span id="shippingVal">Rs. 80</span></div>
      <div class="bill-row total"><span>Total Payable</span><span id="finalTotal">Rs. 0</span></div>
    </div>
  </div>

</div>

<div class="sticky-footer">
  <button class="whatsapp-btn" onclick="proceedToWhatsApp()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
      <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
    </svg>
    Pay on WhatsApp
  </button>
</div>

<div id="confirmBackModal" class="modal">
  <div class="modal-card">
    <h3>Go back to cart?</h3>
    <p style="color:#666; font-size:14px; margin-bottom:20px;">Your details are saved.</p>
    <div class="modal-actions">
      <button class="secondary" onclick="confirmGoBack()">Go Back</button>
      <button class="primary" onclick="closeModal()">Stay Here</button>
    </div>
  </div>
</div>

<script>
  // === CONFIG ===
  const PHONE_NUMBER = "918910344676"; 
  const BASE_PRICE = 249;
  const EXTRA_CHARM_PRICE = 50;

  let cart = [];
  let appliedCoupon = null;
  let currentVibe = "";
  
  function init() {
    const cartData = localStorage.getItem('pyc_cart');
    if (!cartData || JSON.parse(cartData).length === 0) {
      window.location.href = 'cart.html';
      return;
    }
    cart = JSON.parse(cartData);
    const couponData = sessionStorage.getItem('pyc_applied_coupon');
    if (couponData) appliedCoupon = JSON.parse(couponData);

    // 1. Set Flag: User has reached checkout (Enables Bottom Sheet on Home)
    sessionStorage.setItem('pyc_checkout_visited', 'true');

    restoreDraft();
    calculateTotals();

    // === BACK BUTTON HIJACK ===
    setTimeout(() => {
      window.history.pushState(null, null, window.location.href);
    }, 100);
    window.onpopstate = function() {
      handleBackNavigation();
    };
  }

  // ... (Keep calculateTotals, selectVibe, toggleGiftSection, copyContactDetails, handlePhoneInput, handlePincodeInput, fetchPincodeDetails, validateInput EXACTLY AS BEFORE) ...
  // (Paste those functions here if you are replacing the whole block, otherwise just update the ones below)

  function calculateTotals() {
    let subtotal = 0;
    let bracelets = [], earrings = [];
    const getBPrice = (b) => BASE_PRICE + (b.charms.length-1)*EXTRA_CHARM_PRICE;
    const getEPrice = () => BASE_PRICE;
    cart.forEach(item => {
      if(item.type === 'Bracelet') bracelets.push(getBPrice(item));
      else if(item.type === 'Earrings') earrings.push(getEPrice());
      else if(item.type.includes('Combo')) {
        bracelets.push(getBPrice(item.bracelet));
        earrings.push(getEPrice());
      }
    });
    bracelets.forEach(p => subtotal += p);
    earrings.forEach(p => subtotal += p);
    bracelets.sort((a,b) => a-b);
    let comboDiscount = 0;
    const pairs = Math.min(bracelets.length, earrings.length);
    for(let i=0; i<pairs; i++) comboDiscount += Math.floor((bracelets[i] + earrings[i]) * 0.10);
    let discountable = subtotal - comboDiscount;
    let couponDisc = 0;
    let freeShip = false;
    if (appliedCoupon) {
      if (appliedCoupon.freeShip) freeShip = true;
      else if (discountable >= appliedCoupon.minOrder) couponDisc = Math.floor(discountable * (appliedCoupon.percent / 100));
    }
    const pincode = document.getElementById('pincode').value;
    let shipping = 80;
    const msg = document.getElementById('pincodeMsg');
    if (freeShip || (discountable - couponDisc >= 399)) {
      shipping = 0; msg.textContent = "Free shipping applied! ‚ú®"; msg.style.color = "#15803d";
    } else if (pincode && pincode.startsWith("560")) {
      shipping = 50; msg.textContent = "Local delivery: Rs. 50 üõµ"; msg.style.color = "#15803d";
    } else {
      msg.textContent = "Standard Shipping: Rs. 80"; msg.style.color = "#666";
    }
    const total = subtotal - comboDiscount - couponDisc + shipping;
    document.getElementById('subtotalVal').textContent = `Rs. ${subtotal}`;
    const comboEl = document.getElementById('comboRow');
    if(comboDiscount > 0) { comboEl.style.display = 'flex'; document.getElementById('comboVal').textContent = `-Rs. ${comboDiscount}`; } else comboEl.style.display = 'none';
    const coupEl = document.getElementById('couponRow');
    if(couponDisc > 0) { coupEl.style.display = 'flex'; document.getElementById('couponVal').textContent = `-Rs. ${couponDisc}`; } else coupEl.style.display = 'none';
    document.getElementById('shippingVal').textContent = shipping === 0 ? "FREE" : `Rs. ${shipping}`;
    document.getElementById('shippingVal').style.color = shipping === 0 ? "#15803d" : "#555";
    document.getElementById('finalTotal').textContent = `Rs. ${total}`;
  }

  function selectVibe(btn, vibe) {
    document.querySelectorAll('.vibe-chip').forEach(b => b.classList.remove('selected'));
    if(currentVibe === vibe) { currentVibe = ""; document.getElementById('otherVibeInput').style.display = 'none'; } 
    else { btn.classList.add('selected'); currentVibe = vibe; document.getElementById('otherVibeInput').style.display = vibe === 'Other' ? 'block' : 'none'; }
    saveDraft();
  }
  function toggleGiftSection() {
    const isGift = document.getElementById('isGift').checked;
    const sec = document.getElementById('giftSection');
    if(isGift) { sec.style.display = 'block'; setTimeout(() => sec.scrollIntoView({behavior:"smooth", block:"center"}), 100); } 
    else { sec.style.display = 'none'; }
    saveDraft();
  }
  function copyContactDetails() {
    if(document.getElementById('copyDetails').checked) {
      document.getElementById('receiverName').value = document.getElementById('customerName').value;
      const phone = document.getElementById('customerPhone').value;
      document.getElementById('receiverPhone').value = phone;
      validateInput(document.getElementById('receiverName'));
      const e = { inputType: 'insertText' }; handlePhoneInput(e, document.getElementById('receiverPhone')); 
    } else {
      document.getElementById('receiverName').value = ''; document.getElementById('receiverPhone').value = '';
    }
    saveDraft();
  }
  function handlePhoneInput(e, el) {
    let val = el.value.replace(/\D/g, '');
    const isPaste = e.inputType && e.inputType.toLowerCase().includes('paste');
    if (val.length > 10) { if (isPaste || val.length >= 12) val = val.slice(-10); else val = val.slice(0, 10); }
    el.value = val; validateInput(el); saveDraft();
  }
  function handlePincodeInput(el) {
    let val = el.value.replace(/\D/g, '');
    if (val.length > 6) val = val.slice(0, 6);
    el.value = val;
    if(val.length === 6) fetchPincodeDetails(val);
    validateInput(el); saveDraft(); calculateTotals();
  }
  function fetchPincodeDetails(pincode) {
    const msg = document.getElementById('pincodeMsg'); msg.textContent = "Fetching location..."; msg.style.color = "#888";
    fetch(`https://api.postalpincode.in/pincode/${pincode}`).then(res => res.json()).then(data => {
        if(data[0].Status === 'Success') {
          const details = data[0].PostOffice[0];
          document.getElementById('city').value = details.District; document.getElementById('state').value = details.State;
          validateInput(document.getElementById('city')); validateInput(document.getElementById('state'));
          msg.textContent = ""; saveDraft();
        } else { msg.textContent = "Invalid Pincode"; msg.style.color = "#dc2626"; }
      }).catch(err => { console.error(err); msg.textContent = ""; });
  }
  function validateInput(el) { if(el.value.trim() !== "") el.classList.remove('input-error'); }

  // --- UPDATED STORAGE LOGIC ---
  function saveDraft() {
    const data = {
      name: document.getElementById('customerName').value,
      phone: document.getElementById('customerPhone').value,
      email: document.getElementById('customerEmail').value,
      addressLine1: document.getElementById('addressLine1').value,
      addressLine2: document.getElementById('addressLine2').value,
      landmark: document.getElementById('landmark').value,
      city: document.getElementById('city').value,
      state: document.getElementById('state').value,
      pincode: document.getElementById('pincode').value,
      vibe: currentVibe,
      vibeText: document.getElementById('vibeText').value,
      isGift: document.getElementById('isGift').checked,
      receiverName: document.getElementById('receiverName').value,
      receiverPhone: document.getElementById('receiverPhone').value,
      relation: document.getElementById('relation').value,
      occasion: document.getElementById('occasion').value,
      giftMessage: document.getElementById('giftMessage').value
    };
    // CHANGED: Use localStorage for persistence across windows
    localStorage.setItem('checkout_draft_persistent', JSON.stringify(data));
  }

  function restoreDraft() {
    // CHANGED: Read from localStorage
    const data = JSON.parse(localStorage.getItem('checkout_draft_persistent'));
    if(!data) return;

    document.getElementById('customerName').value = data.name || '';
    document.getElementById('customerPhone').value = data.phone || '';
    document.getElementById('customerEmail').value = data.email || '';
    
    document.getElementById('addressLine1').value = data.addressLine1 || '';
    document.getElementById('addressLine2').value = data.addressLine2 || '';
    document.getElementById('landmark').value = data.landmark || '';
    
    document.getElementById('city').value = data.city || '';
    document.getElementById('state').value = data.state || '';
    document.getElementById('pincode').value = data.pincode || '';
    
    if(data.vibe) {
      const chips = document.querySelectorAll('.vibe-chip');
      chips.forEach(c => {
        if(c.textContent.includes(data.vibe)) selectVibe(c, data.vibe);
      });
      if(data.vibe === 'Other') document.getElementById('vibeText').value = data.vibeText || '';
    }

    if(data.isGift) {
      document.getElementById('isGift').checked = true;
      toggleGiftSection();
      document.getElementById('receiverName').value = data.receiverName || '';
      document.getElementById('receiverPhone').value = data.receiverPhone || '';
      document.getElementById('relation').value = data.relation || '';
      document.getElementById('occasion').value = data.occasion || '';
      document.getElementById('giftMessage').value = data.giftMessage || '';
    }
  }
  
  function generateOrderID() {
    const now = new Date();
    const dd = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yyyy = now.getFullYear();
    const HH = String(now.getHours()).padStart(2, '0');
    const MM = String(now.getMinutes()).padStart(2, '0');
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let rand = '';
    for(let i=0; i<5; i++) rand += chars.charAt(Math.floor(Math.random() * chars.length));

    let hasCustom = false;
    let hasReady = false;
    cart.forEach(item => {
        const t = item.type.toLowerCase();
        if(t.includes('bracelet') || t.includes('earring') || t.includes('combo')) hasCustom = true;
        else hasReady = true; 
    });
    let typeCode = 'CM'; 
    if(hasCustom && hasReady) typeCode = 'MX';
    else if(!hasCustom && hasReady) typeCode = 'RM';

    return `PYC-${typeCode}-${dd}${mm}${yyyy}-${HH}${MM}-${rand}`;
  }

  function proceedToWhatsApp() {
    let isValid = true;
    let firstError = null;

    // 1. Validate Fields (Same as before)
    const mandatoryIds = ['customerName', 'customerPhone', 'customerEmail', 'addressLine1', 'addressLine2', 'city', 'state', 'pincode'];
    if(document.getElementById('isGift').checked) {
      mandatoryIds.push('receiverName', 'receiverPhone');
    }

    mandatoryIds.forEach(id => {
      const el = document.getElementById(id);
      const val = el.value.trim();
      let error = false;
      // Empty Check
      if(!val) error = true;
      // Strict Length Check
      if(id.includes('Phone') && val.length !== 10) error = true;
      if(id === 'pincode' && val.length !== 6) error = true;

      if(error) {
        el.classList.add('input-error');
        isValid = false;
        if(!firstError) firstError = el;
      } else {
        el.classList.remove('input-error');
      }
    });

    if(!isValid) {
      firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
      firstError.focus();
      return; 
    }

    // 2. Save Draft (So text isn't lost)
    saveDraft(); 

    // 3. Generate WhatsApp Message (Same as before)
    const data = JSON.parse(sessionStorage.getItem('checkout_draft_v2'));
    const total = document.getElementById('finalTotal').textContent;
    const orderID = generateOrderID();

    let itemsStr = "";
    cart.forEach((item, i) => {
      let desc = item.type;
      if(item.type === 'Bracelet') desc += ` (${item.charms.length} charms)`;
      else if(item.type.includes('Combo')) desc += ` (Combo)`;
      itemsStr += `\n${i+1}. ${desc} - Rs. ${item.price}`;
    });

    let addressBlock = `${data.addressLine1}\n${data.addressLine2}\n`;
    if(data.landmark) addressBlock += `Landmark: ${data.landmark}\n`;
    addressBlock += `${data.city}, ${data.state} - ${data.pincode}`;

    let msg = `Hey PickYourCharms!‚ú®\nI‚Äôve just placed an order and here are the details üíå\n\n*Order ID:* ${orderID} ‚ú®\n\n*Customer:* ${data.name}\nPhone: ${data.phone}\nEmail: ${data.email}\n\n*Address:*\n${addressBlock}\n\n*Order Details:*${itemsStr}\n\n*Total Payable: ${total}*`;

    if(data.vibe) msg += `\n\n*Vibe:* ${data.vibe === 'Other' ? data.vibeText : data.vibe}`;
    if(data.isGift) {
      msg += `\n\nüéÅ *GIFT ORDER*\nTo: ${data.receiverName}\nPhone: ${data.receiverPhone}\nRelation: ${data.relation}\nOccasion: ${data.occasion}\nNote: ${data.giftMessage}`;
    }

    const url = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`;
    
    // 4. SAVE PREFS FOR NEXT TIME
    const prefs = {
        name: data.name, phone: data.phone, email: data.email,
        addressLine1: data.addressLine1, addressLine2: data.addressLine2,
        landmark: data.landmark, city: data.city, state: data.state, pincode: data.pincode
    };
    localStorage.setItem('pyc_user_prefs', JSON.stringify(prefs));

    // 5. OPEN WHATSAPP & REDIRECT TO HOME (Do NOT clear cart here)
    window.open(url, '_blank');
    window.location.replace('index.html?verify=true');
  }

  function handleBackNavigation() {
    document.getElementById('confirmBackModal').style.display = 'flex';
  }
  function confirmGoBack() { 
    saveDraft(); 
    window.location.href = 'cart.html'; 
  }
  function closeModal() { 
    document.getElementById('confirmBackModal').style.display = 'none'; 
  }

  init();
</script>

</body>
</html>
