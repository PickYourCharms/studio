<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Style My Earrings</title>
<link rel="stylesheet" href="styles.css?v=2.5">
    <link rel="stylesheet" href="desktop.css">
    <script src="config.js"></script>
<script src="desktop.js"></script>
    <script src="navigation.js"></script>
<style>
/* Internal overrides */
body { background: #f6f3ec; }
h2 { margin: 8px 0 10px; text-align: center; }
.metal-toggle { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
.metal-toggle button { padding: 8px 18px; border-radius: 999px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
.metal-toggle button.active { background: #000; color: #fff; border-color: #000; }
.builder-surface { background: #fff; border-radius: 26px; padding: 10px 12px 18px; margin: 0 auto; max-width: 420px; box-shadow: 0 18px 40px rgba(0,0,0,0.06); }
.canvas { position: relative; width: 100%; max-width: 360px; aspect-ratio: 1 / 0.8; margin: 0 auto; }
.hook { position: absolute; top: 70px; width: 200px; transform-origin: top center; }
.hook.left { left: 30%; transform: translateX(-50%) scale(var(--scale)); }
.hook.right { left: 70%; transform: translateX(-50%) scale(var(--scale)); }
.hook img { display: block; pointer-events: none; width: 100%; }
.charm { position: absolute; cursor: pointer; transform-origin: top center; }
.charm img { width: 64px; pointer-events: none; }
.price-pill { position: absolute; top: 6%; right: 6%; padding: 6px 14px; border-radius: 999px; background: rgba(255,255,255,0.95); font-size: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.15); opacity: 0; transform: translateY(6px); transition: all 0.2s ease; }
.price-pill.show { opacity: 1; transform: translateY(0); }
.reset-row { text-align: right; margin: 6px auto 10px; max-width: 360px; }
.reset-row button { background: none; border: none; font-size: 14px; color: #777; cursor: pointer; }
.tray-surface { background: #fff; border-radius: 22px; padding: 14px 10px; margin: 14px auto 0; max-width: 420px; box-shadow: 0 12px 28px rgba(0,0,0,0.05); }
.tray { display: flex; justify-content: center; gap: 18px; }
.tray img { width: 44px; cursor: pointer; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 999; }
.modal-card { background: #fff; border-radius: 18px; padding: 20px; width: 86%; max-width: 320px; text-align: center;}
.modal-actions { display: flex; gap: 10px; margin-top: 16px; }
.modal-actions button { flex: 1; padding: 12px; border-radius: 999px; border: none; cursor: pointer; }
.primary { background: #000; color: #fff; }
.secondary { background: #eee; }
</style>
</head>

<body>

<header class="navbar">
  <div class="nav-left">
    <button class="nav-btn" onclick="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
      </svg>
    </button>
  </div>

  <div class="nav-center">
    <a href="index.html" class="logo-link">
      <img src="assets/home/PYC_LOGO_TEXT.png" class="logo-img" alt="PickYourCharms">
    </a>
  </div>

  <div class="nav-right">
    <button id="navCartBtn" class="nav-btn" onclick="window.location.href='cart.html'">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 5.68c.496 2.238.242 3.666-2.203 4.095-.97.17-2.025.218-3.116.218-1.09 0-2.146-.048-3.116-.218-2.445-.429-2.7-1.857-2.203-4.095l1.263-5.68c.24-1.08.385-1.92 2.053-2.008 2.025-.107 4.053-.107 6.078 0 1.668.088 1.813.928 2.053 2.008z" />
      </svg>
    </button>
  </div>
</header>

<div class="main-container">
  <h2 id="pageTitle">Style My Earrings</h2>

  <div class="metal-toggle">
    <button id="goldBtn" class="active" onclick="onMetalClick('gold')">Gold</button>
    <button id="silverBtn" onclick="onMetalClick('silver')">Silver</button>
  </div>

  <div class="builder-surface" id="builderSurface">
    <div class="canvas" id="canvas">
      <div class="hook left" style="--scale:0.5"> <img id="leftHook" src="assets/bases/LeftHook_gold.png"> </div>
      <div class="hook right" style="--scale:0.5"> <img id="rightHook" src="assets/bases/RightHook_gold.png"> </div>
      <div id="pricePill" class="price-pill"></div>
    </div>
    <div class="reset-row"> <button onclick="onResetClick()">Reset</button> </div>
    <div class="helper">Tap a charm to add • Tap charm to remove</div>
  </div>

  <div class="tray-surface"> <div class="tray" id="tray"></div> </div>
</div>

<button id="cta" class="cta">Love it · Add to Bag</button>

<div class="post-actions-container">
  <button class="action-btn btn-build-more" onclick="window.location.href='index.html'">Build More</button>
  <button class="action-btn btn-view-cart" onclick="window.location.href='cart.html'">View Cart</button>
</div>

<div id="modal" class="modal">
  <div class="modal-card">
    <div id="modalText"></div>
    <div class="modal-actions">
      <button class="secondary" onclick="closeModal()">Cancel</button>
      <button class="primary" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<script>
  // --- CONFIG ---
  const PHYSICS = { charmSize: 64, left: { x: 20, y: 100 }, right: { x: 80, y: 100 } };
  
  // Bracelet Physics for Combo View
  const B_PHYSICS = { size:46, anchorX:23, anchorY:6, attachOffset:2 };
  const B_ANGLES = { 1:[90], 2:[70,110], 3:[60,90,120], 4:[45,75,105,135], 5:[40,65,90,115,140] };

  // State
  let metal = 'gold';
  let charms = { left: null, right: null }; // Stores full objects

  // DOM
  const tray = document.getElementById('tray');
  const canvas = document.getElementById('canvas');
  const builderSurface = document.getElementById('builderSurface');
  const modal = document.getElementById('modal');
  const modalText = document.getElementById('modalText');
  const modalConfirm = document.getElementById('modalConfirm');
  const cta = document.getElementById('cta');
  const navCartBtn = document.getElementById('navCartBtn');
  const pageTitle = document.getElementById('pageTitle');
  const pricePill = document.getElementById('pricePill');

  const urlParams = new URLSearchParams(window.location.search);
  const isCombo = urlParams.get('mode') === 'combo';
  const isResume = urlParams.get('resume') === 'true';

  // --- INIT ---
  function init() {
    if (!APP_DATA || APP_DATA.charms.length === 0) {
      window.addEventListener('dataLoaded', init);
      return;
    }

    if (!window.hasSortedCharms) {
      APP_DATA.charms.sort(() => Math.random() - 0.5);
      window.hasSortedCharms = true;
    }

    const cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
    navCartBtn.style.display = cart.length > 0 ? 'block' : 'none';

    if (isResume) {
      const draft = JSON.parse(sessionStorage.getItem('pyc_draft'));
      if (draft && draft.data) {
        metal = draft.data.metal;
        charms = draft.data.charms;
        if(isCombo && draft.comboContext) {
          sessionStorage.setItem('combo_bracelet_data', JSON.stringify(draft.comboContext.bracelet));
        }
      }
    } else if (isCombo) {
      const savedData = sessionStorage.getItem('combo_earring_data');
      if (savedData) {
        const data = JSON.parse(savedData);
        metal = data.metal;
        charms = data.charms;
      }
      cta.textContent = "Love it · Add Bundle to Bag";
    }
    
    updateMetal();
    
    setTimeout(() => {
      window.history.pushState({ page: 'loaded' }, null, window.location.href);
    }, 100); 

    window.onpopstate = function (event) {
      if (document.body.classList.contains('frozen-state')) {
        window.location.href = 'index.html';
        return;
      }
      goBack(); 
    };
  }

  // --- CORE LOGIC ---

  function loadTray() {
    tray.innerHTML = '';
    const visibleCharms = APP_DATA.charms.filter(c => {
      const m = c.metal.toLowerCase();
      return m === metal || m === 'both';
    });

    visibleCharms.forEach(charmObj => {
      const img = document.createElement('img');
      img.src = 'assets/charms/' + charmObj.image_filename;
      img.onclick = () => addCharm(charmObj);
      tray.appendChild(img);
    });
  }

  function addCharm(charmObj) {
    // Fill Left first, then Right
    if(!charms.left) charms.left = charmObj;
    else if(!charms.right) charms.right = charmObj;
    
    // Check Premium Toast
    if(String(charmObj.is_premium).toLowerCase() === 'yes') {
      const lbl = document.getElementById('premiumLabel');
      if(lbl) { lbl.classList.add('show'); setTimeout(() => lbl.classList.remove('show'), 2000); }
    }

    render();
    saveDraft(); 
  }

  function render() {
    document.querySelectorAll('.charm').forEach(el => el.remove());
    
    const hasLeft = !!charms.left;
    const hasRight = !!charms.right;
    
    if (hasLeft) drawCharm('left');
    if (hasRight) drawCharm('right');
    
    cta.classList.toggle('show', hasLeft && hasRight);

    if (hasLeft && hasRight) {
      // --- PRICING LOGIC ---
      const base = Number(APP_DATA.config.earring_base_price || 199);
      const allow = Number(APP_DATA.config.earring_base_charm_allowance || 50);
      let total = base;
      
      // Add difference for left
      if(charms.left) total += Math.max(0, Number(charms.left.price) - allow);
      // Add difference for right
      if(charms.right) total += Math.max(0, Number(charms.right.price) - allow);
      
      pricePill.textContent = 'Rs. ' + total;
      pricePill.classList.add('show');
    } else {
      pricePill.classList.remove('show');
    }
  }

  function drawCharm(side) {
    const hookImg = document.querySelector('.hook.' + side + ' img');
    // Safety check if DOM is ready
    if(!hookImg) return; 

    const h = hookImg.getBoundingClientRect();
    const c = canvas.getBoundingClientRect();
    const w = document.createElement('div');
    w.className = 'charm';
    w.style.left = (h.left - c.left + PHYSICS[side].x - PHYSICS.charmSize/2) + 'px';
    w.style.top = (h.top - c.top + PHYSICS[side].y) + 'px';
    
    const img = document.createElement('img');
    const charmObj = charms[side];
    img.src = 'assets/charms/' + charmObj.image_filename;
    img.style.width = PHYSICS.charmSize + 'px';
    
    w.appendChild(img);
    w.onclick = () => {
      if(document.body.classList.contains('frozen-state')) return;
      charms[side] = null;
      render();
      saveDraft();
    }; 
    canvas.appendChild(w);
  }

  function updateMetal() {
    const leftHook = document.getElementById('leftHook');
    const rightHook = document.getElementById('rightHook');
    
    leftHook.src = 'assets/bases/LeftHook_' + metal + '.png';
    rightHook.src = 'assets/bases/RightHook_' + metal + '.png';
    
    document.getElementById('goldBtn').classList.toggle('active', metal === 'gold');
    document.getElementById('silverBtn').classList.toggle('active', metal === 'silver');
    loadTray();
    render();
  }
  
  function onMetalClick(next) {
    if (next === metal) return;
    if (charms.left || charms.right) {
      showModal('Switching metal will reset your design.', () => {
        charms = {left: null, right: null};
        metal = next;
        updateMetal();
        saveDraft(); 
      });
    } else { 
      metal = next; 
      updateMetal(); 
      saveDraft(); 
    }
  }

  function onResetClick() {
    if (!charms.left && !charms.right) return;
    showModal('Reset earring design?', () => {
      charms = {left: null, right: null};
      render();
      saveDraft();
    });
  }

  // --- ACTIONS ---

  function saveDraft() {
    const isEmpty = !charms.left && !charms.right;
    let comboCtx = null;
    if(isCombo) {
      const bData = sessionStorage.getItem('combo_bracelet_data');
      if(bData) comboCtx = { bracelet: JSON.parse(bData) };
    }

    if (isEmpty && (!isCombo || !comboCtx)) {
      sessionStorage.removeItem('pyc_draft');
      return;
    }

    const draftData = {
      url: 'earring-builder.html' + window.location.search,
      data: { metal, charms },
      comboContext: comboCtx,
      timestamp: Date.now()
    };
    sessionStorage.setItem('pyc_draft', JSON.stringify(draftData));
  }

  function goBack() {
    if (document.body.classList.contains('frozen-state')) {
      window.location.href = 'index.html';
      return;
    }
    if (isCombo) {
      const state = { metal, charms };
      sessionStorage.setItem('combo_earring_data', JSON.stringify(state));
      window.location.href = 'builder.html?mode=combo&resume=true';
    } else {
      history.back();
    }
  }

  // --- ADD TO CART (AND COMBO LOGIC) ---
  
  cta.onclick = function() {
    if(!cta.classList.contains('show')) return;
    
    // Calculate Final Earring Price
    const base = Number(APP_DATA.config.earring_base_price);
    const allow = Number(APP_DATA.config.earring_base_charm_allowance);
    let ePrice = base;
    if(charms.left) ePrice += Math.max(0, Number(charms.left.price) - allow);
    if(charms.right) ePrice += Math.max(0, Number(charms.right.price) - allow);

    if (isCombo) {
      // COMBO FLOW
      const braceletData = JSON.parse(sessionStorage.getItem('combo_bracelet_data'));
      
      // Calculate Bracelet Price (Re-calc to be safe)
      const bBase = Number(APP_DATA.config.bracelet_base_price);
      const bAllow = Number(APP_DATA.config.bracelet_base_charm_allowance);
      let bPrice = bBase;
      braceletData.charms.forEach((c, i) => {
        if(i===0) bPrice += Math.max(0, Number(c.price) - bAllow);
        else bPrice += Number(c.price);
      });

      // Calculate Combo Price (Discount applies to SUM)
      const discountPercent = Number(APP_DATA.config.combo_discount_percent);
      const combinedTotal = bPrice + ePrice;
      const finalComboPrice = Math.floor(combinedTotal * ((100 - discountPercent) / 100));

      const product = {
        id: Date.now(),
        type: 'Combo (Bracelet + Earrings)',
        bracelet: { ...braceletData, price: bPrice },
        earrings: { metal, charms, price: ePrice },
        price: finalComboPrice,
        image: 'assets/home/model_combo_mobile.png'
      };
      
      // Clear Stash
      sessionStorage.removeItem('combo_bracelet_data');
      sessionStorage.removeItem('combo_earring_data');
      
      addToCart(product);
      
      // UI: Combo Visuals
      renderComboVisuals(braceletData);

    } else {
      // SINGLE FLOW
      const product = {
        id: Date.now(),
        type: 'Earrings',
        metal: metal,
        charms: charms,
        price: ePrice,
        image: 'assets/bases/LeftHook_' + metal + '.png' 
      };
      addToCart(product);
    }
  };

  function addToCart(item) {
    window.history.pushState({ page: 'frozen' }, null, window.location.href);
    let cart = JSON.parse(localStorage.getItem('pyc_cart') || '[]');
    cart.push(item);
    localStorage.setItem('pyc_cart', JSON.stringify(cart));
    sessionStorage.removeItem('pyc_draft');

    document.body.classList.add('frozen-state');
    navCartBtn.style.display = 'block';
    
    if(isCombo) pageTitle.textContent = "The Perfect Duo ✨";
    else pageTitle.textContent = "Added to Bag ✨";
  }

  function renderComboVisuals(braceletData) {
    // Inject the Bracelet preview above earrings
    const comboStack = document.createElement('div');
    comboStack.className = 'combo-stack';
    
    const bCanvas = document.createElement('div');
    bCanvas.className = 'canvas bracelet-preview';
    
    const bImg = document.createElement('img');
    bImg.className = 'bracelet-base-img';
    bImg.src = 'assets/bases/bracelet_base_' + braceletData.metal + '.png';
    bCanvas.appendChild(bImg);
    
    // Render Bracelet Charms
    const bRect = { width: 300, height: 300 };
    const cx = bRect.width/2, cy = bRect.height/2;
    const radius = bRect.width * 0.36;
    const angles = B_ANGLES[braceletData.charms.length];
    
    braceletData.charms.forEach((cObj, i) => {
       const a = angles[angles.length-1-i];
       const rad = a * Math.PI / 180;
       const x = cx + radius * Math.cos(rad);
       const y = cy + radius * Math.sin(rad) + B_PHYSICS.attachOffset;
       
       const w = document.createElement('div');
       w.className = 'bracelet-charm';
       w.style.left = (x - B_PHYSICS.anchorX) + 'px';
       w.style.top = (y - B_PHYSICS.anchorY) + 'px';
       w.style.transform = 'rotate(' + (a - 90) + 'deg)';
       
       const img = document.createElement('img');
       img.src = 'assets/charms/' + cObj.image_filename;
       img.style.width = '100%';
       w.appendChild(img);
       bCanvas.appendChild(w);
    });
    
    comboStack.appendChild(bCanvas);
    comboStack.appendChild(canvas);
    builderSurface.insertBefore(comboStack, builderSurface.firstChild);
  }

  // --- MODALS ---
  function showModal(text, fn) {
    modalText.textContent = text;
    modalConfirm.onclick = () => { closeModal(); fn(); };
    modal.style.display = 'flex';
  }
  function closeModal() { modal.style.display = 'none'; }

  init();
</script>
</body>
</html>
